{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "928421655697634832"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Azure region for all resources."
      }
    },
    "baseName": {
      "type": "string",
      "defaultValue": "gh-runner",
      "metadata": {
        "description": "Project-friendly base name used for resource naming."
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags applied to all resources."
      }
    },
    "logAnalyticsRetentionInDays": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "Retention in days for Log Analytics workspace."
      }
    },
    "containerAppEnvironmentName": {
      "type": "string",
      "defaultValue": "[format('{0}-env', parameters('baseName'))]",
      "metadata": {
        "description": "Name for Container Apps managed environment."
      }
    },
    "virtualNetworkAddressPrefix": {
      "type": "string",
      "defaultValue": "10.10.0.0/16",
      "metadata": {
        "description": "Virtual network CIDR block for the Container Apps environment."
      }
    },
    "containerAppsSubnetPrefix": {
      "type": "string",
      "defaultValue": "10.10.0.0/23",
      "metadata": {
        "description": "Subnet CIDR dedicated to the Container Apps environment (min /27)."
      }
    },
    "platformReservedCidr": {
      "type": "string",
      "defaultValue": "10.200.0.0/24",
      "metadata": {
        "description": "CIDR reserved for platform infrastructure IP addresses; must not overlap with the virtual network."
      }
    },
    "platformReservedDnsIp": {
      "type": "string",
      "defaultValue": "10.200.0.10",
      "metadata": {
        "description": "DNS IP address from within the platform reserved CIDR range."
      }
    },
    "dockerBridgeCidr": {
      "type": "string",
      "defaultValue": "172.16.0.0/16",
      "metadata": {
        "description": "CIDR range for the Docker bridge network used by the environment."
      }
    },
    "internalEnvironment": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploy the Container Apps environment as internal only when true (no public ingress)."
      }
    },
    "workloadProfiles": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Workload profile definitions for the Container Apps environment. Leave empty to default to the required Consumption profile when integrating with a delegated subnet."
      }
    },
    "containerImage": {
      "type": "string",
      "metadata": {
        "description": "Fully qualified container image path (e.g., myacr.azurecr.io/github-actions-runner:1.0)."
      }
    },
    "containerCpu": {
      "type": "string",
      "defaultValue": "2.0",
      "metadata": {
        "description": "Container CPU cores (expressed as string to support decimal values)."
      }
    },
    "containerMemory": {
      "type": "string",
      "defaultValue": "4Gi",
      "metadata": {
        "description": "Container memory allocation (e.g., 4Gi)."
      }
    },
    "runnerLabels": {
      "type": "string",
      "defaultValue": "self-hosted,azure-container-apps",
      "metadata": {
        "description": "Job runner labels (comma-separated string)."
      }
    },
    "githubOwner": {
      "type": "string",
      "metadata": {
        "description": "GitHub repository owner (organization or user)."
      }
    },
    "githubRepo": {
      "type": "string",
      "metadata": {
        "description": "GitHub repository name."
      }
    },
    "githubPatSecretName": {
      "type": "string",
      "defaultValue": "personal-access-token",
      "metadata": {
        "description": "Secret name used to store GitHub PAT (resolved via Container Apps secrets)."
      }
    },
    "githubPatSecretValue": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Secret value for GitHub PAT. Leave empty when using GitHub App authentication."
      }
    },
    "githubAppKeySecretName": {
      "type": "string",
      "defaultValue": "github-app-key",
      "metadata": {
        "description": "Secret name used to expose the GitHub App private key to the runner job when using GitHub App authentication."
      }
    },
    "githubAppPrivateKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "GitHub App private key in PEM format. Provide when using GitHub App authentication; leave empty to fall back to PAT."
      }
    },
    "additionalEnv": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional additional environment variables passed to the runner container."
      }
    },
    "minExecutions": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "Minimum job executions triggered per polling interval."
      }
    },
    "maxExecutions": {
      "type": "int",
      "defaultValue": 10,
      "metadata": {
        "description": "Maximum job executions triggered per polling interval."
      }
    },
    "pollingInterval": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "Polling interval (seconds) for the GitHub runner KEDA scaler."
      }
    },
    "targetWorkflowQueueLength": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Target workflow queue length before scaling additional executions."
      }
    },
    "userAssignedIdentityId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional user-assigned managed identity resource ID for the job and registry access."
      }
    },
    "acrName": {
      "type": "string",
      "defaultValue": "[format('{0}acr', parameters('baseName'))]",
      "metadata": {
        "description": "When deploying a new ACR, specify the name (must be globally unique)."
      }
    },
    "acrSku": {
      "type": "string",
      "defaultValue": "Basic",
      "metadata": {
        "description": "SKU for new ACR (Basic, Standard, Premium)."
      }
    },
    "githubApiUrl": {
      "type": "string",
      "defaultValue": "https://api.github.com",
      "metadata": {
        "description": "GitHub API endpoint used by the scaler; override for GitHub Enterprise."
      }
    },
    "githubServerUrl": {
      "type": "string",
      "defaultValue": "https://github.com",
      "metadata": {
        "description": "Base GitHub server URL for the runner to register against."
      }
    },
    "githubRunnerScope": {
      "type": "string",
      "defaultValue": "repo",
      "allowedValues": [
        "repo",
        "org",
        "ent"
      ],
      "metadata": {
        "description": "Scope used by the GitHub runner scaler (repo, org, ent)."
      }
    },
    "githubRunnerRepositories": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Override the comma-delimited repository list monitored by the scaler. Defaults to githubRepo when the scope is repo."
      }
    },
    "disableDefaultRunnerLabels": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Disable default runner labels (self-hosted, linux, x64) when true."
      }
    },
    "matchUnlabeledRunnerJobs": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Match unlabeled GitHub jobs with unlabeled runners when true."
      }
    },
    "enableGithubEtags": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable GitHub API etag support to reduce rate limit usage when true."
      }
    },
    "githubAppApplicationId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional GitHub App application ID for scaler authentication."
      }
    },
    "githubAppInstallationId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional GitHub App installation ID for scaler authentication."
      }
    },
    "additionalScaleRuleAuth": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Additional KEDA scale rule auth entries (array of objects with triggerParameter and secretRef)."
      }
    }
  },
  "variables": {
    "locationNormalized": "[toLower(replace(parameters('location'), ' ', ''))]",
    "workspaceName": "[format('{0}-{1}-law', parameters('baseName'), variables('locationNormalized'))]",
    "logAnalyticsResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]",
    "githubApiUrlNormalized": "[if(endsWith(parameters('githubApiUrl'), '/'), substring(parameters('githubApiUrl'), 0, max(sub(length(parameters('githubApiUrl')), 1), 0)), parameters('githubApiUrl'))]",
    "githubServerUrlNormalized": "[if(endsWith(parameters('githubServerUrl'), '/'), substring(parameters('githubServerUrl'), 0, max(sub(length(parameters('githubServerUrl')), 1), 0)), parameters('githubServerUrl'))]",
    "githubRunnerUrl": "[if(equals(parameters('githubRunnerScope'), 'org'), format('{0}/{1}', variables('githubServerUrlNormalized'), parameters('githubOwner')), if(equals(parameters('githubRunnerScope'), 'ent'), format('{0}/enterprises/{1}', variables('githubServerUrlNormalized'), parameters('githubOwner')), format('{0}/{1}/{2}', variables('githubServerUrlNormalized'), parameters('githubOwner'), parameters('githubRepo'))))]",
    "githubRegistrationTokenApiUrl": "[if(equals(parameters('githubRunnerScope'), 'org'), format('{0}/orgs/{1}/actions/runners/registration-token', variables('githubApiUrlNormalized'), parameters('githubOwner')), if(equals(parameters('githubRunnerScope'), 'ent'), format('{0}/enterprises/{1}/actions/runners/registration-token', variables('githubApiUrlNormalized'), parameters('githubOwner')), format('{0}/repos/{1}/{2}/actions/runners/registration-token', variables('githubApiUrlNormalized'), parameters('githubOwner'), parameters('githubRepo'))))]",
    "githubScaleRepositories": "[if(empty(parameters('githubRunnerRepositories')), if(equals(parameters('githubRunnerScope'), 'repo'), parameters('githubRepo'), ''), parameters('githubRunnerRepositories'))]",
    "useGithubAppAuth": "[and(and(not(empty(parameters('githubAppApplicationId'))), not(empty(parameters('githubAppInstallationId')))), not(empty(parameters('githubAppPrivateKey'))))]",
    "usePatAuth": "[not(empty(parameters('githubPatSecretValue')))]",
    "sanitizedBaseName": "[replace(toLower(parameters('baseName')), '-', '')]",
    "keyVaultUniqueSuffix": "[substring(uniqueString(resourceGroup().id, parameters('baseName')), 0, 13)]",
    "generatedKeyVaultName": "[take(format('kv{0}{1}', variables('sanitizedBaseName'), variables('keyVaultUniqueSuffix')), 24)]",
    "scaleSecretName": "[if(variables('useGithubAppAuth'), parameters('githubAppKeySecretName'), if(variables('usePatAuth'), parameters('githubPatSecretName'), ''))]",
    "scaleAuthTriggerParameter": "[if(variables('useGithubAppAuth'), 'appKey', 'personalAccessToken')]",
    "baseRunnerEnv": [
      {
        "name": "GH_URL",
        "value": "[variables('githubRunnerUrl')]"
      },
      {
        "name": "GITHUB_API_URL",
        "value": "[variables('githubApiUrlNormalized')]"
      },
      {
        "name": "REGISTRATION_TOKEN_API_URL",
        "value": "[variables('githubRegistrationTokenApiUrl')]"
      },
      {
        "name": "RUNNER_LABELS",
        "value": "[parameters('runnerLabels')]"
      }
    ],
    "runnerAuthEnv": "[if(variables('useGithubAppAuth'), createArray(createObject('name', 'APP_ID', 'value', parameters('githubAppApplicationId')), createObject('name', 'APP_INSTALLATION_ID', 'value', parameters('githubAppInstallationId')), createObject('name', 'APP_PRIVATE_KEY', 'secretRef', parameters('githubAppKeySecretName'))), if(variables('usePatAuth'), createArray(createObject('name', 'GITHUB_PAT', 'secretRef', parameters('githubPatSecretName'))), createArray()))]",
    "runnerEnv": "[concat(variables('baseRunnerEnv'), variables('runnerAuthEnv'), parameters('additionalEnv'))]",
    "acrPullRoleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
    "keyVaultSecretsUserRoleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]"
  },
  "resources": {
    "acrResource": {
      "existing": true,
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2025-04-01",
      "name": "[parameters('acrName')]",
      "dependsOn": [
        "acr"
      ]
    },
    "keyVaultResource": {
      "condition": "[variables('useGithubAppAuth')]",
      "existing": true,
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2025-05-01",
      "name": "[variables('generatedKeyVaultName')]"
    },
    "jobAcrPull": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
      "name": "[guid(parameters('acrName'), format('{0}-job', parameters('baseName')), 'acrPull')]",
      "properties": {
        "roleDefinitionId": "[variables('acrPullRoleDefinitionId')]",
        "principalId": "[reference('job').outputs.principalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "acr",
        "job"
      ]
    },
    "jobKeyVaultSecrets": {
      "condition": "[variables('useGithubAppAuth')]",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', variables('generatedKeyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', variables('generatedKeyVaultName')), format('{0}-job', parameters('baseName')), 'kvSecretsUser')]",
      "properties": {
        "roleDefinitionId": "[variables('keyVaultSecretsUserRoleDefinitionId')]",
        "principalId": "[reference('job').outputs.principalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "job",
        "keyVault"
      ]
    },
    "network": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-network', parameters('baseName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-vnet', parameters('baseName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "addressPrefix": {
            "value": "[parameters('virtualNetworkAddressPrefix')]"
          },
          "subnetName": {
            "value": "[format('{0}-ca-subnet', parameters('baseName'))]"
          },
          "subnetPrefix": {
            "value": "[parameters('containerAppsSubnetPrefix')]"
          },
          "nsgName": {
            "value": "[format('{0}-nsg', parameters('baseName'))]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "11923279765312686358"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "addressPrefix": {
              "type": "string"
            },
            "subnetName": {
              "type": "string",
              "defaultValue": "containerapps-infra"
            },
            "subnetPrefix": {
              "type": "string"
            },
            "nsgName": {
              "type": "string",
              "defaultValue": "[format('{0}-nsg', parameters('name'))]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "securityRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Additional security rules to append to the NSG. Each rule should follow the Microsoft.Network/networkSecurityGroups securityRules schema."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-10-01",
              "name": "[parameters('nsgName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": "[parameters('securityRules')]"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-10-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('addressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[parameters('subnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('subnetPrefix')]",
                      "delegations": [
                        {
                          "name": "containerAppsDelegation",
                          "properties": {
                            "serviceName": "Microsoft.App/environments"
                          }
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
            },
            "subnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('name'), parameters('subnetName'))]"
            },
            "networkSecurityGroupId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
            }
          }
        }
      }
    },
    "works": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-log', parameters('baseName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('workspaceName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "retentionInDays": {
            "value": "[parameters('logAnalyticsRetentionInDays')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17860698188402685873"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2025-02-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionInDays')]"
              }
            }
          ],
          "outputs": {
            "customerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('name')), '2025-02-01').customerId]"
            },
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
            }
          }
        }
      }
    },
    "env": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-env', parameters('baseName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('containerAppEnvironmentName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsCustomerId": {
            "value": "[reference('works').outputs.customerId.value]"
          },
          "logAnalyticsSharedKey": {
            "value": "[listKeys(variables('logAnalyticsResourceId'), '2025-02-01').primarySharedKey]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "workloadProfiles": {
            "value": "[parameters('workloadProfiles')]"
          },
          "infrastructureSubnetId": {
            "value": "[reference('network').outputs.subnetId.value]"
          },
          "platformReservedCidr": {
            "value": "[parameters('platformReservedCidr')]"
          },
          "platformReservedDnsIp": {
            "value": "[parameters('platformReservedDnsIp')]"
          },
          "dockerBridgeCidr": {
            "value": "[parameters('dockerBridgeCidr')]"
          },
          "internalEnvironment": {
            "value": "[parameters('internalEnvironment')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16333241532456431961"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "logAnalyticsCustomerId": {
              "type": "string"
            },
            "logAnalyticsSharedKey": {
              "type": "securestring"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "workloadProfiles": {
              "type": "array",
              "defaultValue": []
            },
            "infrastructureSubnetId": {
              "type": "string"
            },
            "platformReservedCidr": {
              "type": "string"
            },
            "platformReservedDnsIp": {
              "type": "string"
            },
            "dockerBridgeCidr": {
              "type": "string"
            },
            "internalEnvironment": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "defaultWorkloadProfiles": [
              {
                "name": "consumption",
                "workloadProfileType": "Consumption"
              }
            ],
            "effectiveWorkloadProfiles": "[if(empty(parameters('workloadProfiles')), variables('defaultWorkloadProfiles'), parameters('workloadProfiles'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2025-01-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[parameters('logAnalyticsCustomerId')]",
                    "sharedKey": "[parameters('logAnalyticsSharedKey')]"
                  }
                },
                "vnetConfiguration": {
                  "infrastructureSubnetId": "[parameters('infrastructureSubnetId')]",
                  "platformReservedCidr": "[parameters('platformReservedCidr')]",
                  "platformReservedDnsIP": "[parameters('platformReservedDnsIp')]",
                  "dockerBridgeCidr": "[parameters('dockerBridgeCidr')]",
                  "internal": "[parameters('internalEnvironment')]"
                },
                "workloadProfiles": "[variables('effectiveWorkloadProfiles')]"
              }
            }
          ],
          "outputs": {
            "environmentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "network",
        "works"
      ]
    },
    "acr": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-acr', parameters('baseName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('acrName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[parameters('acrSku')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "principalId": "[if(empty(parameters('userAssignedIdentityId')), createObject('value', ''), createObject('value', reference(parameters('userAssignedIdentityId'), '2018-11-30', 'Full').principalId))]",
          "principalType": {
            "value": "ServicePrincipal"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "10307187177465925126"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "sku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ]
            },
            "adminUserEnabled": {
              "type": "bool",
              "defaultValue": false
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "principalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional principal to grant AcrPull permissions to (e.g. user-assigned managed identity)."
              }
            },
            "principalType": {
              "type": "string",
              "defaultValue": "ServicePrincipal",
              "allowedValues": [
                "ServicePrincipal",
                "User",
                "Group",
                "ForeignGroup"
              ]
            }
          },
          "variables": {
            "acrPullRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2025-04-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "adminUserEnabled": "[parameters('adminUserEnabled')]",
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "condition": "[not(empty(parameters('principalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('name'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), parameters('principalId'), variables('acrPullRoleId'))]",
              "properties": {
                "roleDefinitionId": "[variables('acrPullRoleId')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "[parameters('principalType')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "registryId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
            },
            "loginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2025-04-01').loginServer]"
            }
          }
        }
      }
    },
    "keyVault": {
      "condition": "[variables('useGithubAppAuth')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-kv', parameters('baseName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('generatedKeyVaultName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9555808208038691010"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault (3-24 characters, alphanumeric)."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for the Key Vault."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags applied to the Key Vault resource."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2025-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "enableRbacAuthorization": true,
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                }
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
            }
          }
        }
      }
    },
    "githubAppKeySecret": {
      "condition": "[variables('useGithubAppAuth')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-github-app-key', parameters('baseName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vaultName": {
            "value": "[variables('generatedKeyVaultName')]"
          },
          "secretName": {
            "value": "[parameters('githubAppKeySecretName')]"
          },
          "secretValue": {
            "value": "[parameters('githubAppPrivateKey')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "5673909817422246423"
            }
          },
          "parameters": {
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags applied to the Key Vault secret."
              }
            },
            "vaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the target Key Vault."
              }
            },
            "secretName": {
              "type": "string",
              "metadata": {
                "description": "Name of the secret to create or update."
              }
            },
            "secretValue": {
              "type": "securestring",
              "metadata": {
                "description": "Value of the secret stored in the Key Vault."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2025-05-01",
              "name": "[format('{0}/{1}', parameters('vaultName'), parameters('secretName'))]",
              "tags": "[parameters('tags')]",
              "properties": {
                "value": "[parameters('secretValue')]"
              }
            }
          ],
          "outputs": {
            "uri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('vaultName'), parameters('secretName')), '2025-05-01').secretUri]"
            }
          }
        }
      }
    },
    "job": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-job', parameters('baseName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-job', parameters('baseName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentId": {
            "value": "[reference('env').outputs.environmentId.value]"
          },
          "image": {
            "value": "[parameters('containerImage')]"
          },
          "containerCpu": {
            "value": "[parameters('containerCpu')]"
          },
          "containerMemory": {
            "value": "[parameters('containerMemory')]"
          },
          "containerEnv": {
            "value": "[variables('runnerEnv')]"
          },
          "jobSecrets": "[if(variables('useGithubAppAuth'), createObject('value', createArray(createObject('name', parameters('githubAppKeySecretName'), 'keyVaultUrl', if(variables('useGithubAppAuth'), reference(resourceId('Microsoft.KeyVault/vaults/secrets', variables('generatedKeyVaultName'), parameters('githubAppKeySecretName')), '2025-05-01', 'Full').properties.secretUri, ''), 'identity', if(empty(parameters('userAssignedIdentityId')), 'system', parameters('userAssignedIdentityId'))))), if(variables('usePatAuth'), createObject('value', createArray(createObject('name', parameters('githubPatSecretName'), 'value', parameters('githubPatSecretValue')))), createObject('value', createArray())))]",
          "registries": {
            "value": [
              {
                "server": "[reference('acr').outputs.loginServer.value]",
                "identity": "[if(empty(parameters('userAssignedIdentityId')), 'system', parameters('userAssignedIdentityId'))]"
              }
            ]
          },
          "systemAssigned": {
            "value": true
          },
          "userAssignedIdentityId": {
            "value": "[parameters('userAssignedIdentityId')]"
          },
          "parallelism": {
            "value": 1
          },
          "replicaCompletionCount": {
            "value": 1
          },
          "replicaRetryLimit": {
            "value": 0
          },
          "replicaTimeout": {
            "value": 1800
          },
          "minExecutions": {
            "value": "[parameters('minExecutions')]"
          },
          "maxExecutions": {
            "value": "[parameters('maxExecutions')]"
          },
          "pollingInterval": {
            "value": "[parameters('pollingInterval')]"
          },
          "githubOwner": {
            "value": "[parameters('githubOwner')]"
          },
          "githubApiUrl": {
            "value": "[variables('githubApiUrlNormalized')]"
          },
          "runnerScope": {
            "value": "[parameters('githubRunnerScope')]"
          },
          "githubRepositories": {
            "value": "[variables('githubScaleRepositories')]"
          },
          "scaleRunnerLabels": {
            "value": "[parameters('runnerLabels')]"
          },
          "noDefaultLabels": {
            "value": "[parameters('disableDefaultRunnerLabels')]"
          },
          "matchUnlabeledJobsWithUnlabeledRunners": {
            "value": "[parameters('matchUnlabeledRunnerJobs')]"
          },
          "enableEtags": {
            "value": "[parameters('enableGithubEtags')]"
          },
          "applicationId": "[if(variables('useGithubAppAuth'), createObject('value', parameters('githubAppApplicationId')), createObject('value', ''))]",
          "installationId": "[if(variables('useGithubAppAuth'), createObject('value', parameters('githubAppInstallationId')), createObject('value', ''))]",
          "targetWorkflowQueueLength": {
            "value": "[parameters('targetWorkflowQueueLength')]"
          },
          "scaleSecretName": {
            "value": "[variables('scaleSecretName')]"
          },
          "scaleAuthTriggerParameter": {
            "value": "[variables('scaleAuthTriggerParameter')]"
          },
          "additionalScaleRuleAuth": {
            "value": "[parameters('additionalScaleRuleAuth')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9530587117537170878"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "environmentId": {
              "type": "string"
            },
            "image": {
              "type": "string"
            },
            "containerCpu": {
              "type": "string",
              "defaultValue": "2.0",
              "metadata": {
                "description": "Container CPU in cores (supports values such as 0.5, 1.0, 2.0)."
              }
            },
            "containerMemory": {
              "type": "string",
              "defaultValue": "4Gi"
            },
            "containerEnv": {
              "type": "array",
              "defaultValue": []
            },
            "jobSecrets": {
              "type": "array",
              "defaultValue": []
            },
            "registries": {
              "type": "array",
              "defaultValue": []
            },
            "githubOwner": {
              "type": "string",
              "metadata": {
                "description": "GitHub organization or user that owns the repositories monitored by the scaler."
              }
            },
            "githubApiUrl": {
              "type": "string",
              "defaultValue": "https://api.github.com",
              "metadata": {
                "description": "GitHub API endpoint used by the scaler; override for GitHub Enterprise."
              }
            },
            "runnerScope": {
              "type": "string",
              "defaultValue": "repo",
              "allowedValues": [
                "repo",
                "org",
                "ent"
              ],
              "metadata": {
                "description": "Scope for the GitHub runner scaler (repo, org, or ent)."
              }
            },
            "githubRepositories": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Comma-delimited list of repositories when using repo scope. Leave empty to monitor all repositories for the owner."
              }
            },
            "scaleRunnerLabels": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional comma-delimited list of runner labels to match when scaling."
              }
            },
            "noDefaultLabels": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Disable default runner labels (self-hosted, linux, x64) when set to true."
              }
            },
            "matchUnlabeledJobsWithUnlabeledRunners": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Match unlabeled jobs with unlabeled runners when set to true."
              }
            },
            "enableEtags": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable GitHub API conditional requests using etags to reduce rate limit usage."
              }
            },
            "applicationId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "GitHub App application ID when authenticating with a GitHub App."
              }
            },
            "installationId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "GitHub App installation ID when authenticating with a GitHub App."
              }
            },
            "targetWorkflowQueueLength": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Target workflow queue length used by the scaler before spawning additional runners."
              }
            },
            "scaleSecretName": {
              "type": "string",
              "defaultValue": "personal-access-token",
              "metadata": {
                "description": "Secret name that holds the personal access token or GitHub App key for scaling."
              }
            },
            "additionalScaleRuleAuth": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Additional scale rule auth entries (for example, GitHub App appKey)."
              }
            },
            "scaleAuthTriggerParameter": {
              "type": "string",
              "defaultValue": "personalAccessToken",
              "metadata": {
                "description": "Trigger parameter name used in the scale rule auth (for example, personalAccessToken or appKey)."
              }
            },
            "systemAssigned": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable system-assigned managed identity for the job."
              }
            },
            "userAssignedIdentityId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional single user-assigned managed identity resource ID to associate with the job."
              }
            },
            "parallelism": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Parallelism determines how many replicas run per execution."
              }
            },
            "replicaCompletionCount": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Number of replicas required to report success before the job execution is marked successful."
              }
            },
            "replicaRetryLimit": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "Maximum retry count for failed replicas."
              }
            },
            "replicaTimeout": {
              "type": "int",
              "defaultValue": 1800,
              "metadata": {
                "description": "Maximum execution time in seconds per replica."
              }
            },
            "minExecutions": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "Minimum executions triggered per polling interval."
              }
            },
            "maxExecutions": {
              "type": "int",
              "defaultValue": 10,
              "metadata": {
                "description": "Maximum executions triggered per polling interval."
              }
            },
            "pollingInterval": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "KEDA polling interval in seconds."
              }
            },
            "command": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Optional environment variables to override command arguments."
              }
            },
            "args": {
              "type": "array",
              "defaultValue": []
            }
          },
          "variables": {
            "identityType": "[if(parameters('systemAssigned'), if(empty(parameters('userAssignedIdentityId')), 'SystemAssigned', 'SystemAssigned,UserAssigned'), if(empty(parameters('userAssignedIdentityId')), 'None', 'UserAssigned'))]",
            "scaleRuleMetadata": "[union(createObject('githubAPIURL', parameters('githubApiUrl'), 'owner', parameters('githubOwner'), 'runnerScope', parameters('runnerScope'), 'targetWorkflowQueueLength', string(parameters('targetWorkflowQueueLength'))), if(empty(parameters('githubRepositories')), createObject(), createObject('repos', parameters('githubRepositories'))), if(empty(parameters('scaleRunnerLabels')), createObject(), createObject('labels', parameters('scaleRunnerLabels'))), if(parameters('noDefaultLabels'), createObject('noDefaultLabels', 'true'), createObject()), if(parameters('matchUnlabeledJobsWithUnlabeledRunners'), createObject('matchUnlabeledJobsWithUnlabeledRunners', 'true'), createObject()), if(parameters('enableEtags'), createObject('enableEtags', 'true'), createObject()), if(empty(parameters('applicationId')), createObject(), createObject('applicationID', parameters('applicationId'))), if(empty(parameters('installationId')), createObject(), createObject('installationID', parameters('installationId'))))]",
            "baseScaleRuleAuth": "[if(or(empty(parameters('scaleSecretName')), empty(parameters('scaleAuthTriggerParameter'))), createArray(), createArray(createObject('triggerParameter', parameters('scaleAuthTriggerParameter'), 'secretRef', parameters('scaleSecretName'))))]",
            "scaleRuleAuth": "[concat(variables('baseScaleRuleAuth'), parameters('additionalScaleRuleAuth'))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/jobs",
              "apiVersion": "2025-01-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "[variables('identityType')]",
                "userAssignedIdentities": "[if(empty(parameters('userAssignedIdentityId')), createObject(), createObject(format('{0}', parameters('userAssignedIdentityId')), createObject()))]"
              },
              "properties": {
                "environmentId": "[parameters('environmentId')]",
                "configuration": {
                  "triggerType": "Event",
                  "replicaRetryLimit": "[parameters('replicaRetryLimit')]",
                  "replicaTimeout": "[parameters('replicaTimeout')]",
                  "secrets": "[parameters('jobSecrets')]",
                  "registries": "[parameters('registries')]",
                  "eventTriggerConfig": {
                    "parallelism": "[parameters('parallelism')]",
                    "replicaCompletionCount": "[parameters('replicaCompletionCount')]",
                    "scale": {
                      "minExecutions": "[parameters('minExecutions')]",
                      "maxExecutions": "[parameters('maxExecutions')]",
                      "pollingInterval": "[parameters('pollingInterval')]",
                      "rules": [
                        {
                          "name": "github-runner",
                          "type": "github-runner",
                          "metadata": "[variables('scaleRuleMetadata')]",
                          "auth": "[variables('scaleRuleAuth')]"
                        }
                      ]
                    }
                  }
                },
                "template": {
                  "containers": [
                    {
                      "name": "runner",
                      "image": "[parameters('image')]",
                      "env": "[parameters('containerEnv')]",
                      "command": "[parameters('command')]",
                      "args": "[parameters('args')]",
                      "resources": {
                        "cpu": "[json(parameters('containerCpu'))]",
                        "memory": "[parameters('containerMemory')]"
                      }
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "jobId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/jobs', parameters('name'))]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/jobs', parameters('name')), '2025-01-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "acr",
        "env"
      ]
    }
  },
  "outputs": {
    "containerAppsEnvironmentId": {
      "type": "string",
      "value": "[reference('env').outputs.environmentId.value]"
    },
    "containerAppsJobId": {
      "type": "string",
      "value": "[reference('job').outputs.jobId.value]"
    },
    "jobPrincipalId": {
      "type": "string",
      "value": "[reference('job').outputs.principalId.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference('works').outputs.workspaceId.value]"
    },
    "containerRegistryId": {
      "type": "string",
      "value": "[reference('acr').outputs.registryId.value]"
    },
    "containerRegistryLoginServer": {
      "type": "string",
      "value": "[reference('acr').outputs.loginServer.value]"
    },
    "virtualNetworkId": {
      "type": "string",
      "value": "[reference('network').outputs.virtualNetworkId.value]"
    },
    "containerAppsSubnetId": {
      "type": "string",
      "value": "[reference('network').outputs.subnetId.value]"
    },
    "networkSecurityGroupId": {
      "type": "string",
      "value": "[reference('network').outputs.networkSecurityGroupId.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[if(variables('useGithubAppAuth'), variables('generatedKeyVaultName'), '')]"
    },
    "githubAppKeySecretUri": {
      "type": "string",
      "value": "[if(variables('useGithubAppAuth'), if(variables('useGithubAppAuth'), reference(resourceId('Microsoft.KeyVault/vaults/secrets', variables('generatedKeyVaultName'), parameters('githubAppKeySecretName')), '2025-05-01', 'Full').properties.secretUri, ''), '')]"
    }
  }
}