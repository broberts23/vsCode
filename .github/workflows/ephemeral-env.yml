name: Ephemeral PR Environment
on:
  pull_request:
    types: [opened, reopened, labeled]

jobs:
  provision:
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    if: github.event.action != 'labeled'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Resolve Runner Service Principal ObjectId
        run: |
          echo "RUNNER_SP_OBJECTID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)" >> $GITHUB_ENV
      - name: Ensure Resource Group Exists
        run: |
          az group create --name pr-${{ github.event.number }}-rg --location eastus --tags pr=${{ github.event.number }}
      - name: Deploy Bicep (Identity + Infra)
        run: |
          az deployment group create \
            --resource-group pr-${{ github.event.number }}-rg \
            --template-file project-bicep-graph/infra/main.bicep \
            --parameters prNumber=${{ github.event.number }} location='eastus' runnerPrincipalObjectId=$RUNNER_SP_OBJECTID \
            --query properties.outputs --output json > env-outputs.json
      - name: Display Deployment Outputs
        run: cat env-outputs.json
      - name: Build WebApi
        run: |
          dotnet publish project-bicep-graph/src/WebApi/WebApi.csproj -c Release -o publish
      - name: Zip Publish Directory
        run: |
          cd publish
          zip -r ../publish.zip .
          cd -
      - name: Deploy WebApi to App Service
        run: |
          WEBAPP_NAME=$(jq -r '.webAppName.value' env-outputs.json)
          az webapp deploy --resource-group pr-${{ github.event.number }}-rg --name "$WEBAPP_NAME" --src-path publish.zip --type zip
      - name: Assign Swagger.Admin role to test group (if present)
        shell: pwsh
        run: |
          $o = Get-Content env-outputs.json | ConvertFrom-Json
          $spId = $o.servicePrincipalObjectId.value
          $roleId = $o.swaggerAdminRoleId.value
          $grpName = $o.testGroupDisplayName.value
          $grpId = $o.testGroupObjectId.value
          if ([string]::IsNullOrWhiteSpace($grpName)) {
            Write-Host 'No test group provided; skipping role assignment.'
          } else {
            $env:RESOURCE_SP_OBJECTID = $spId
            $env:APP_ROLE_ID = $roleId
            $env:GROUP_DISPLAY_NAME = $grpName
            $env:GROUP_OBJECT_ID = $grpId
            $env:APPLICATION_APP_ID = '${{ secrets.AZURE_CLIENT_ID }}'
            $env:APPLICATION_SP_OBJECTID = $env:RUNNER_SP_OBJECTID
            pwsh -File project-bicep-graph/scripts/Assign-AppRoleToGroup.ps1 | Tee-Object -FilePath approle-assignment.json
            Get-Content approle-assignment.json
          }
      - name: Create Ephemeral Test Users
        shell: pwsh
        run: |
          $o = Get-Content env-outputs.json | ConvertFrom-Json
          $grpId = $o.testGroupObjectId.value
          if ([string]::IsNullOrWhiteSpace($grpId)) { Write-Host 'No test group objectId; skipping user creation.' } else {
            $env:GROUP_OBJECT_ID = $grpId
            $env:PR_NUMBER = '${{ github.event.number }}'
            pwsh -File project-bicep-graph/scripts/Create-TestUsers.ps1 | Tee-Object -FilePath test-users.json
            Write-Host 'Created test users:'
            Get-Content test-users.json
          }
      - name: Upload Outputs Artifact
        uses: actions/upload-artifact@v4
        with:
          name: env-outputs
          path: env-outputs.json
      - name: Upload Test Users Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-users
          path: test-users.json

  smoke-tests:
    needs: provision
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    if: github.event.action != 'labeled'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download env outputs
        uses: actions/download-artifact@v4
        with:
          name: env-outputs
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true
      - name: PowerShell Smoke Tests
        shell: pwsh
        run: |
          $o = Get-Content env-outputs.json | ConvertFrom-Json
          $aud = $o.appAudience.value
          $kv = $o.keyVaultName.value
          $st = $o.storageAccountName.value
          $api = $o.webAppUrl.value
          $clientId = '${{ secrets.AZURE_CLIENT_ID }}'
          $adminToken = $null
          $adminTokenError = $null
          try { $adminToken = az account get-access-token --scope "$aud/.default" --query accessToken -o tsv }
          catch { $adminTokenError = $_.Exception.Message }
          if (-not $adminToken) {
            try { $adminToken = az account get-access-token --scope "$(jq -r '.appId.value' env-outputs.json)/.default" --query accessToken -o tsv } catch { }
          }
          $userToken = $adminToken # same principal; keep for future differentiation
          . project-bicep-graph/scripts/SmokeTests.ps1
          try {
            $resultObject = Invoke-EphemeralSmokeTests -VaultName $kv -StorageAccountName $st -ApiBaseUrl $api -AdminBearerToken $adminToken -UserBearerToken $userToken
          }
          catch {
            $err = $_.Exception.Message
            $resultObject = [pscustomobject]@{
              Success     = $false
              Error       = "Smoke tests failed: $err"
              Environment = $null
              KeyVault    = [pscustomobject]@{ Accessible = $false; Error = "Invoke-EphemeralSmokeTests failed: $err" }
              Storage     = [pscustomobject]@{ Accessible = $false; Error = "Invoke-EphemeralSmokeTests failed: $err" }
              Api         = [pscustomobject]@{ Healthz = $null; Health = $null; BaseUrl = $api; HealthStatus = $null }
              CompletedAt = (Get-Date).ToString('o')
            }
          }
          $json = $resultObject | ConvertTo-Json -Depth 8
          $json | Out-File smoke-results.json
          $obj = $json | ConvertFrom-Json
          $authConfigured = if ($obj.PSObject.Properties.Name -contains 'Api' -and $obj.Api -and $obj.Api.PSObject.Properties.Name -contains 'Healthz' -and $obj.Api.Healthz -and $obj.Api.Healthz.PSObject.Properties.Name -contains 'authConfigured') { $obj.Api.Healthz.authConfigured } else { 'Error' }
          $healthzStatus = if ($obj.PSObject.Properties.Name -contains 'Api' -and $obj.Api -and $obj.Api.PSObject.Properties.Name -contains 'Healthz' -and $obj.Api.Healthz -and $obj.Api.Healthz.PSObject.Properties.Name -contains 'status') { $obj.Api.Healthz.status } else { 'Error' }
          $healthStatus = if ($obj.PSObject.Properties.Name -contains 'Api' -and $obj.Api -and $obj.Api.PSObject.Properties.Name -contains 'Health' -and $obj.Api.Health -and $obj.Api.Health.PSObject.Properties.Name -contains 'status') { $obj.Api.Health.status } else { 'Error' }
          $overall = if ($obj.PSObject.Properties.Name -contains 'Success') { [bool]$obj.Success } else { $false }
          echo "### Smoke Test Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $env:GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| API Auth Configured | $authConfigured |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Admin API /healthz | $healthzStatus |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Protected API /health | $healthStatus |" >> $env:GITHUB_STEP_SUMMARY
          $kvAccessible = if ($obj.PSObject.Properties.Name -contains 'KeyVault' -and $obj.KeyVault -and $obj.KeyVault.PSObject.Properties.Name -contains 'Accessible') { $obj.KeyVault.Accessible } else { 'Error' }
          $stAccessible = if ($obj.PSObject.Properties.Name -contains 'Storage' -and $obj.Storage -and $obj.Storage.PSObject.Properties.Name -contains 'Accessible') { $obj.Storage.Accessible } else { 'Error' }
          echo "| Key Vault Accessible | $kvAccessible |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Storage Accessible | $stAccessible |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Overall | $overall |" >> $env:GITHUB_STEP_SUMMARY
          if (-not $overall) { Write-Error "Smoke tests failed. See smoke-results.json for details." }
      - name: Ensure Smoke Results Exists
        if: always()
        shell: pwsh
        run: |
          if (-not (Test-Path smoke-results.json)) {
            $fallback = [pscustomobject]@{
              Success = $false
              Error   = 'Smoke test step failed before results were written.'
              When    = (Get-Date).ToString('o')
            }
            $fallback | ConvertTo-Json -Depth 4 | Out-File smoke-results.json
          }
      - name: Upload Smoke Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-results
          path: smoke-results.json

  destroy:
    # Run on label application; independent of provision/smoke (which are skipped on labeled action)
    if: github.event.action == 'labeled' && (github.event.label.name == 'Destroy' || github.event.label.name == 'destroy')
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set PR Number Env
        run: echo "PR_NUMBER=${{ github.event.number }}" >> $GITHUB_ENV
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Find Previous Successful Run (Provision Artifacts)
        id: find_prev_run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Query workflow runs for this workflow file
          curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/ephemeral-env.yml/runs?event=pull_request&per_page=50" > runs.json
          # Extract latest completed successful run (excluding current) for this PR number
          PREV_RUN_ID=$(jq -r --arg cur "${{ github.run_id }}" --argjson pr ${{ github.event.number }} '(.workflow_runs | map(select((.id|tostring) != $cur and .status=="completed" and .conclusion=="success" and (.pull_requests | any(.number == $pr))))) | sort_by(.run_number) | last | (.id // "")')
          if [ "$PREV_RUN_ID" = "null" ] || [ -z "$PREV_RUN_ID" ]; then
            echo "No previous successful run artifacts found for this PR number; proceeding with objectId-only cleanup (no heuristic lookups).";
            PREV_RUN_ID="";
          fi
          echo "prev_run_id=$PREV_RUN_ID" >> $GITHUB_OUTPUT
      - name: Download env-outputs artifact (previous run)
        if: ${{ steps.find_prev_run.outputs.prev_run_id != '' }}
        uses: actions/download-artifact@v5
        with:
          name: env-outputs
          run-id: ${{ steps.find_prev_run.outputs.prev_run_id }}
          github-token: ${{ github.token }}
      - name: Download test-users artifact (previous run)
        if: ${{ steps.find_prev_run.outputs.prev_run_id != '' }}
        uses: actions/download-artifact@v5
        with:
          name: test-users
          run-id: ${{ steps.find_prev_run.outputs.prev_run_id }}
          github-token: ${{ github.token }}
      - name: Download env outputs
        uses: actions/download-artifact@v4
        with:
          name: env-outputs
        continue-on-error: true
      - name: Download test users
        uses: actions/download-artifact@v4
        with:
          name: test-users
        continue-on-error: true
      - name: Delete Test Users
        shell: pwsh
        run: |
          if (Test-Path env-outputs.json) {
            $o = Get-Content env-outputs.json | ConvertFrom-Json
            $grpId = $o.testGroupObjectId.value
            if ($grpId) { $env:GROUP_OBJECT_ID = $grpId }
          }
          $env:PR_NUMBER = '${{ github.event.number }}'
          pwsh -File project-bicep-graph/scripts/Delete-TestUsers.ps1 | Tee-Object -FilePath deleted-users.json
          Get-Content deleted-users.json
      - name: Cleanup Graph Objects (App / SP / Group)
        shell: pwsh
        run: |
          if (Test-Path env-outputs.json) { $env:ENV_OUTPUTS_PATH = 'env-outputs.json' }
          $env:PR_NUMBER = '${{ github.event.number }}'
          pwsh -File project-bicep-graph/scripts/Cleanup-GraphEphemeral.ps1 | Tee-Object -FilePath graph-cleanup.json
          Get-Content graph-cleanup.json
      - name: Delete Resource Group (Placeholder)
        run: |
          az group delete --name pr-${{ github.event.number }}-rg --yes --no-wait