name: PIM Elevate Demo

on:
  workflow_dispatch:
    inputs:
      roleIds:
        description: 'JSON array of role IDs (e.g. ["guid1","guid2"])'
        required: false
        default: '[]'
      resourceIds:
        description: 'JSON array of Azure resource IDs (e.g. ["/subscriptions/...","/subscriptions/..."])'
        required: false
        default: '[]'
      vaultName:
        description: 'Key Vault name (optional)'
        required: false
      secretName:
        description: 'Secret name to rotate (optional)'
        required: false

  workflow_call:
    inputs:
      roleIds:
        required: false
        type: string
        default: '[]'
      resourceIds:
        required: false
        type: string
        default: '[]'
      subscriptionId:
        required: false
        type: string
        description: 'Optional subscription id; if provided the template will replace <AZURE_SUBSCRIPTION_ID> placeholders in resourceIds.'
        default: ''
      vaultName:
        required: false
        type: string
      secretName:
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  request-elevation:
    name: Request elevation and notify
    runs-on: windows-latest
    outputs:
      assignee: ${{ steps.set-vars.outputs.assignee }}
      vault: ${{ steps.set-vars.outputs.vault }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true
      
      - name: Resolve automation principal objectId (RBAC-based)
        shell: pwsh
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          $clientId = $env:AZURE_CLIENT_ID
          $subId = $env:AZURE_SUBSCRIPTION_ID
          if (-not $clientId -or -not $subId) { throw 'AZURE_CLIENT_ID or AZURE_SUBSCRIPTION_ID not available in environment.' }

          $principalId = (& az role assignment list --assignee $clientId --scope "/subscriptions/$subId" --query '[0].principalId' -o tsv) 2>$null
          $principalId = ($principalId | Out-String).Trim()
          if (-not $principalId) { throw 'Could not resolve principalId via role assignment list. Ensure the principal has a role assignment at subscription scope.' }

          "ASSIGNEE_OBJECT_ID=$principalId" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          

      - name: Create activation requests and build approval table
        id: set-vars
        shell: pwsh
        env:
          ROLE_IDS: ${{ inputs.roleIds || github.event.inputs.roleIds || '[]' }}
          RESOURCE_IDS: ${{ inputs.resourceIds || github.event.inputs.resourceIds || '[]' }}
          SUBSCRIPTION_ID: ${{ inputs.subscriptionId || github.event.inputs.subscriptionId || secrets.AZURE_SUBSCRIPTION_ID || '' }}
          VAULT_NAME: ${{ inputs.vaultName || github.event.inputs.vaultName || '' }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          pwsh ./project-jit-pim/scripts/build-approval.ps1
      - name: Notify approvers via PR comment (only on pull_request)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        env:
          APPROVAL_TABLE: ${{ steps.set-vars.outputs.approvalTable }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const table = process.env.APPROVAL_TABLE || '';
            const body = `PIM rotation request created. Please review and approve in the Environments/Approvals gate to proceed.\n\nRequested activations:\n${table}`;
            const prNumber = context.payload.pull_request.number;
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber, body });

      - name: Add approval table to job summary (non-PR events)
        if: ${{ github.event_name != 'pull_request' }}
        shell: pwsh
        env:
          APPROVAL_TABLE: ${{ steps.set-vars.outputs.approvalTable }}
        run: |
          "### PIM rotation request" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          $env:APPROVAL_TABLE | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

  approve-and-rotate:
    name: Approve and rotate (requires manual approval)
    needs: request-elevation
    runs-on: windows-latest
    # Environment gate: configure this environment in repo settings with required reviewers
    # to enforce a manual "Approve" click before this job executes.
    environment:
      name: pim-rotation-approval
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          enable-AzPSSession: true

      - name: Resolve automation principal objectId (RBAC-based)
        shell: pwsh
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          $clientId = $env:AZURE_CLIENT_ID
          $subId = $env:AZURE_SUBSCRIPTION_ID
          if (-not $clientId -or -not $subId) { throw 'AZURE_CLIENT_ID or AZURE_SUBSCRIPTION_ID not available in environment.' }

          $principalId = (& az role assignment list --assignee $clientId --scope "/subscriptions/$subId" --query '[0].principalId' -o tsv) 2>$null
          $principalId = ($principalId | Out-String).Trim()
          if (-not $principalId) { throw 'Could not resolve principalId via role assignment list. Ensure the principal has a role assignment at subscription scope.' }

          "ASSIGNEE_OBJECT_ID=$principalId" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run rotation under approved gate
        shell: pwsh
        env:
          ROLE_IDS: ${{ inputs.roleIds || github.event.inputs.roleIds || '[]' }}
          RESOURCE_IDS: ${{ inputs.resourceIds || github.event.inputs.resourceIds || '[]' }}
          SUBSCRIPTION_ID: ${{ inputs.subscriptionId || github.event.inputs.subscriptionId || secrets.AZURE_SUBSCRIPTION_ID || '' }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          $workspace = $env:GITHUB_WORKSPACE
          if (-not $workspace) { throw 'GITHUB_WORKSPACE environment variable is required.' }

          $modulePath = Join-Path $workspace 'project-jit-pim/scripts/PimAutomation.psm1'
          Import-Module -Name $modulePath -Force

          $roleIdsJson = if ($env:ROLE_IDS) { $env:ROLE_IDS } else { '[]' }
          $resourceIdsJson = if ($env:RESOURCE_IDS) { $env:RESOURCE_IDS } else { '[]' }

          $pairs = Resolve-PimRoleResourcePairs -RoleIdsJson $roleIdsJson -ResourceIdsJson $resourceIdsJson -SubscriptionId $env:SUBSCRIPTION_ID
          $pairs = @($pairs)
          if ($pairs.Count -lt 1) { throw 'No valid role/resource pairs to process (roleIds or resourceIds were empty).' }

          $first = $pairs[0]
          pwsh ./project-jit-pim/scripts/run-activation.ps1 -RoleId $first.RoleId -ResourceId $first.ResourceId -Justification 'Approved by approver'
