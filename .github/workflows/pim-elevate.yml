name: PIM Elevate Demo

on:
  workflow_dispatch:
    inputs:
      roleIds:
        description: 'JSON array of role IDs (e.g. ["guid1","guid2"])'
        required: false
        default: '[]'
      resourceIds:
        description: 'JSON array of Azure resource IDs (e.g. ["/subscriptions/...","/subscriptions/..."])'
        required: false
        default: '[]'
      vaultName:
        description: 'Key Vault name (optional)'
        required: false
      secretName:
        description: 'Secret name to rotate (optional)'
        required: false

  workflow_call:
    inputs:
      roleIds:
        required: false
        type: string
        default: '[]'
      resourceIds:
        required: false
        type: string
        default: '[]'
      subscriptionId:
        required: false
        type: string
        description: 'Optional subscription id; if provided the template will replace <AZURE_SUBSCRIPTION_ID> placeholders in resourceIds.'
        default: ''
      vaultName:
        required: false
        type: string
      secretName:
        required: false
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  request-elevation:
    name: Request elevation and notify
    runs-on: ubuntu-latest
    outputs:
      assignee: ${{ steps.set-vars.outputs.assignee }}
      vault: ${{ steps.set-vars.outputs.vault }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          

      - name: Create activation requests and build approval table
        id: set-vars
        shell: pwsh
        env:
          ROLE_IDS: ${{ inputs.roleIds || github.event.inputs.roleIds || '[]' }}
          RESOURCE_IDS: ${{ inputs.resourceIds || github.event.inputs.resourceIds || '[]' }}
          SUBSCRIPTION_ID: ${{ inputs.subscriptionId || github.event.inputs.subscriptionId || secrets.AZURE_SUBSCRIPTION_ID || '' }}
          VAULT_NAME: ${{ inputs.vaultName || github.event.inputs.vaultName || '' }}
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          # Parse inputs (JSON arrays)
          try {
            $roles = ConvertFrom-Json $env:ROLE_IDS
          } catch { $roles = @() }
          try {
            $resources = ConvertFrom-Json $env:RESOURCE_IDS
          } catch { $resources = @() }

          # Ensure parsed values are arrays so .Count and enumeration work reliably.
          # Create explicit array views; even if $roles/$resources are scalars, @($var) yields a 1-item array.
          $rolesArr = @($roles)
          $resourcesArr = @($resources)

          # Replace placeholder <AZURE_SUBSCRIPTION_ID> in resource IDs when a subscriptionId input is provided
          $subscriptionId = $env:SUBSCRIPTION_ID
          if (($null -ne $subscriptionId) -and ($subscriptionId -ne '')) {
            $resources = $resources | ForEach-Object { $_ -replace '<AZURE_SUBSCRIPTION_ID>', $subscriptionId }
          }

          # Refresh array view after any substitution
          $resourcesArr = @($resources)

          # Build pairing logic:
          # - If single role and multiple resources: apply that role to all resources (one-to-many)
          # - If single resource and multiple roles: apply each role to that resource (many-to-one)
          # - If equal-length arrays: pair by index
          # - Else (multiple roles and multiple resources with unequal counts): create cartesian product
          $pairs = @()
          $rolesCount = @($rolesArr).Count
          $resourcesCount = @($resourcesArr).Count
          if (($rolesCount -eq 1) -and ($resourcesCount -ge 1)) {
            foreach ($res in @($resourcesArr)) { $pairs += [pscustomobject]@{ RoleId = $rolesArr[0]; ResourceId = $res } }
          } elseif (($resourcesCount -eq 1) -and ($rolesCount -ge 1)) {
            foreach ($r in @($rolesArr)) { $pairs += [pscustomobject]@{ RoleId = $r; ResourceId = $resourcesArr[0] } }
          } elseif ($rolesCount -eq $resourcesCount) {
            for ($i = 0; $i -lt $rolesCount; $i++) { $pairs += [pscustomobject]@{ RoleId = $rolesArr[$i]; ResourceId = $resourcesArr[$i] } }
          } else {
            # Cartesian product fallback
            foreach ($r in @($rolesArr)) { foreach ($res in @($resourcesArr)) { $pairs += [pscustomobject]@{ RoleId = $r; ResourceId = $res } } }
          }

          # Build a markdown table header and requests list
          $table = "| RoleId | RoleName | ResourceId | ResourceName | ResourceType | RequestId |`n|---|---|---|---|---|---|`n"
          $requests = @()
          Import-Module -Name (Join-Path $PSScriptRoot 'PimAutomation.psm1')
          foreach ($pair in $pairs) {
            $roleId = $pair.RoleId; $resourceId = $pair.ResourceId
            # Create PIM activation request (no secret rotation yet)
            $req = New-PimActivationRequest -RoleId $roleId -ResourceId $resourceId -Justification 'CI requested activation'
            $requests += $req

            # Resolve role name and resource details (best-effort)
            $roleName = $roleId
            try {
              $rj = az role definition show --id $roleId -o json 2>$null | ConvertFrom-Json
              if ($rj -and $rj.roleName) { $roleName = $rj.roleName } elseif ($rj -and $rj.properties -and $rj.properties.roleName) { $roleName = $rj.properties.roleName }
            } catch { }

            $resName = $resourceId; $resType = ''
            try {
              $resj = az resource show --ids $resourceId -o json 2>$null | ConvertFrom-Json
              if ($resj) { $resName = $resj.name; $resType = $resj.type }
            } catch { }

            # Escape pipes in markdown and wrap ids/names in inline code ticks for clarity
            $escape = { param($s) if ($null -eq $s) { return '``' } else { return ('`' + ($s -replace '\|', '\\|') + '`') } }
            $rIdCell = & $escape $roleId
            $rNameCell = & $escape $roleName
            $resIdCell = & $escape $resourceId
            $resNameCell = & $escape $resName
            $resTypeCell = & $escape $resType

            $reqId = $req.requestId -or $req.id -or ([guid]::NewGuid()).Guid
            $reqIdCell = & $escape $reqId
            $table += "| $rIdCell | $rNameCell | $resIdCell | $resNameCell | $resTypeCell | $reqIdCell |`n"
          }

          # Export outputs: assignee, vault, and the approval markdown table
          if ($env:GITHUB_OUTPUT) {
            "approvalTable<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            $table | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "assignee=${env:ASSIGNEE_OBJECT_ID}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "vault=${env:VAULT_RESOURCE_ID}" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Output "approvalTable:"; Write-Output $table
            Write-Output "assignee: $env:ASSIGNEE_OBJECT_ID"; Write-Output "vault: $env:VAULT_RESOURCE_ID"
          }
      - name: Notify approvers via workflow comment
        uses: actions/github-script@v7
        env:
          APPROVAL_TABLE: ${{ steps.set-vars.outputs.approvalTable }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const table = process.env.APPROVAL_TABLE || '';
            const body = `PIM rotation request created. Please review and approve in the Environments/Approvals gate to proceed.\n\nRequested activations:\n${table}`;
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number || 1, body });

  approve-and-rotate:
    name: Approve and rotate (requires manual approval)
    needs: request-elevation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run rotation under approved gate
        shell: pwsh
        run: |
          pwsh ./project-jit-pim/scripts/run-activation.ps1 -RoleId 'role-demo' -ResourceId 'res-demo' -Justification 'Approved by approver'
