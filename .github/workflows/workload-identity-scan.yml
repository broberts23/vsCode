name: Workload Identity Risk Scan

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # Daily UTC scan

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  scan:
    runs-on: ubuntu-latest
    env:
      SCAN_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Module Dependencies
        shell: pwsh
        run: |
          ./project-workload-identity/scripts/Install-Dependencies.ps1

      - name: Run Workload Identity Scan
        shell: pwsh
        run: |
          ./project-workload-identity/scripts/Scan-And-Report.ps1 -TenantId $env:SCAN_TENANT_ID -Scopes @('Application.Read.All','Directory.Read.All','IdentityRiskyServicePrincipal.Read.All') -OutputPath './out'

      - name: Render HTML Report
        shell: pwsh
        run: |
          ./project-workload-identity/scripts/Write-ScanReport.ps1 -OutputFolder ./out

      - name: Publish Report Summary
        shell: pwsh
        env:
          REPORT_PATH: ./out/workload-identity-report.html
        run: |
          ./project-workload-identity/scripts/Publish-ScanReportSummary.ps1 -ReportPath $env:REPORT_PATH

      - name: Upload Full Scan Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wi-scan-artifacts
          path: out/
          if-no-files-found: error

      - name: Upload Risky SP Triage (Convenience)
        uses: actions/upload-artifact@v4
        with:
          name: wi-risky-sp-triage
          path: out/risky-service-principal-triage.json
          if-no-files-found: warn
